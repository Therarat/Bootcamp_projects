create table personal (  --Dimtable
  personalID int not null primary key,
  name varchar(200) ,
  surname varchar(200) 
);
  
insert into personal values
  (1, 'Therarat','Srisaswatakul'),
  (2, 'Suwipawan','Aroonmas'),
  (3, 'Manoon','Thorudee'),
  (4, 'Pawarut','Kongrat');

create table clothType (  --Dimtable
  type int not null primary key,
  typeName varchar(200)
);

insert into clothType values
  (1, 'Vintage'),
  (2, 'Cartoon'),
  (3, 'Wong');

create table payLocation(   --Dimtable
  location int not null primary key,
  locationName varchar(200)
);

insert into payLocation values
  (1, 'Thailand'),
  (2, 'Canada'),
  (3, 'USA');

create table orders (     --Facttable
  ordersID int primary key,
  personalID int ,
  purchaseDate date,
  totalPay real,
  type int,
  location int,
  foreign key (personalID) references personal(personalID) ,
  foreign key (type) references clothType(type),
  foreign key (location) references payLocation(location)
);

insert into orders values
  (1, 1, 2020-05-08, 500.25, 1, 1),
  (2, 1, 2021-01-09, 1500, 1, 3),
  (3, 2, 2018-09-04, 480, 2, 1),
  (4, 3, 2018-08-05, 80, 3, 2),
  (5, 4, 1994-11-04, 8000, 2, 3),
  (6, 3, 1995-09-04, 1600, 3, 3),
  (7, 2, 2007-12-22, 5000, 1, 1),
  (8, 4, 2010-11-19, 2600, 2, 2),
  (9, 3, 2010-09-24, 3000, 3, 2),
  (10, 2, 2012-06-29, 10000, 1,3)
;

.mode markdown
.header on

--With clause
--Join table (orders + personal + payLocation) 
  
WITH orders_name_location as (
  select 
    orders.ordersID as order_ID,
    personal.name as Name,
    orders.totalPay as payment,
    payLocation.locationName as location 
  from orders
    join personal on orders.personalID = personal.personalID
    join payLocation on orders.location = payLocation.location)

select * 
from orders_name_location
where location in ('Thailand','USA');


--Use sub query for analysis

select * 
from
  (select 
    orders.ordersID as order_ID,
    personal.name as Name,
    orders.totalPay as payment,
    payLocation.locationName as location 
  from orders
    join personal on orders.personalID = personal.personalID
    join payLocation on orders.location = payLocation.location
    join clothType on clothType.type = orders.type
  );

WITH orders_name_location as (
  select 
    orders.ordersID as order_ID,
    personal.name as Name,
    orders.totalPay as payment,
    payLocation.locationName as location 
  from orders
    join personal on orders.personalID = personal.personalID
    join payLocation on orders.location = payLocation.location)

select 
  name ,
  count(*) as Amount_pay
from orders_name_location
group by name 
order by count(*) desc ;
